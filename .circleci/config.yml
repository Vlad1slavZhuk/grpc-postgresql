version: 2.1

jobs:
  tests:
    docker:
      - image: golang:latest
    environment:
      GO111MODULE: "on"
    steps: 
      - checkout
      - run:
          name: Test with gotestsum
          command: |
            go get gotest.tools/gotestsum
            gotestsum --format json || (gotestsum --format json > test_results.json && exit 1)
          when: always
      - run:
          name: Lint with golangci-lint
          command: |
            go get github.com/golangci/golangci-lint/cmd/golangci-lint
            golangci-lint run --out-format=json > golangci-lint-results.json || true
          when: always
      - store_artifacts:
          path: |
            ./test_results.json
            ./golangci-lint-results.json
          destination: test_results
         
  build:
    docker:
      - image: docker:latest
    steps:
      - checkout
      - run:
          name: Build Docker image  
          command: |
            if [[ "$CIRCLE_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              docker build -t grpc-postgresql:$CIRCLE_SHA1 -f /build/Dockerfile .
            else
              echo "Skipping Docker image build and tag because this is not a semver tag or a merge to main/master."
            fi
                        
  deploy:
    docker:
      - image: grpc-postgresql:$CIRCLE_SHA1
    steps:
      - run:
          name: Push Docker image to Docker Hub
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker push grpc-postgresql:$CIRCLE_SHA1


workflows:
  grpc-postgresql-workflow:
    jobs:
      - tests:
          name: Lint with golangci-lint
      - tests:
          name: Test with gotestsum
      - build:
          requires:
            - tests
          filters:
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+$/
      - deploy:
          requires:
            - build
          filters:
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+$/
